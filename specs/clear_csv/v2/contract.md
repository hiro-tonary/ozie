# クリア取込用売上げデータ Contract（v2 計画）

本ドキュメントは、得意先マスタ編集機能を追加した次期バージョンの仕様です。現行版（v1）の詳細は `specs/clear_csv/v1/contract.md` を参照してください。

## 1. 目的と範囲

- クリア取込用売上げデータ画面に「得意先編集」ボタンを追加し、運用担当が UI 上からマスタを更新できるようにする。
- 得意先マスタは `Config::$customer_path` に保存されたタブ区切りファイルを参照し、存在しない場合は従来の `Customers::$datas` を初期値として利用する。
- 対象ファイル
  - 既存: `tool/download/csv_for_clear.php`, `tool/download/tmp_download.php`, `tool/include/Customers.php`
  - 新規: `tool/download/customers_edit.php`（名称は目安。テスト環境側も同構成で実装）

## 2. データ構造

- `Config::$customer_path` にタブ区切りファイルを保存。1 行 1 レコード、列順は以下の通り。
  1. `id`（得意先コード）
  2. `shop_id`（Next Engine 店舗番号）
  3. `name`（画面表示用の得意先名）
  4. `shop_name`（CSV に出力する店舗名）
  5. `tax_type`（課税 / 非課税 など）
  6. `tax_method`（内税 / 免税 など）
  7. `jan`（ポイント・送料など追加行で使用する商品コード。不要なら空）
  8. `goods_name`（追加行の表示名。不要なら空）
- ファイルが存在しない場合は `Customers::$datas` の内容をそのまま書き出し、以後はファイルを参照する。

## 3. クリア取込画面（csv_for_clear.php）

### 3.1 UI 変更
- 得意先リストの右上に「得意先編集」ボタンを追加。クリックで `customers_edit.php` へ遷移し、CSRF 対策の token を合わせて送信する。

### 3.2 処理フロー
1. 初期化時に `Config::$customer_path` を読み込み、存在しない場合は `Customers::$datas` を利用してファイルを生成する。
2. 得意先チェックボックスはファイル内容で描画する。
3. CSV 生成フローは v1 と同様。追加行の `tax_type` や `tax_method` などはファイルから取得した値を利用する。

## 4. 得意先編集画面（customers_edit.php）

### 4.1 画面仕様
- 現在のマスタ内容をタブ区切りテキストとしてテキストエリアに表示。
- 「保存」ボタンで `mode=save` を POST。token を検証し、入力内容をバリデーションしたうえで `Config::$customer_path` に書き出す。
- 保存成功後は完了メッセージを表示し、元の画面への戻りリンクを提供。

### 4.2 バリデーション
- 行のカラム数が不足していないか。
- `id` と `shop_id` が重複していないか。
- `tax_type` / `tax_method` が運用で定めた許容値に収まっているか（未定義の場合は警告またはエラー扱い）。
- 必須列が空の場合はエラーを出す。

### 4.3 ファイル保存
- 保存前に既存ファイルのバックアップ（例: `.bak`）を作成することを推奨。
- 書き込みは `Config::$customer_path` のみに限定し、パス検証でディレクトリトラバーサルを防止する。

## 5. セキュリティ

- 既存画面と同様に `X-Frame-Options: DENY`、`Cache-Control: no-store` 等を設定。
- クリア取込画面と編集画面の双方で `Tonary::session_start()` → token 検証を徹底。
- ファイル書き込みはアプリケーションが許可したパスのみ。権限設定や所有者に注意する。

## 6. テスト観点

- 初回アクセス時に `Config::$customer_path` が生成されること。
- 得意先を編集・保存した内容がクリア取込画面に即時反映されること。
- 不正フォーマットの入力で適切なエラーメッセージを表示すること。
- 既存の CSV 出力（ポイント・ギフト・送料などの追加行）が編集後のマスタでも正しく動作すること。

## 7. 運用上の留意事項

- 運用チームは CSV 出力を確認したうえで、本番環境 (`tool/`) へ反映する。手順はテスト環境での編集 → 動作確認 → 本番への適用という順序を守る。
- バージョン管理対象は `Customers.php`（テンプレート）と Contract 各種であり、実際のマスタファイルは環境依存のためリポジトリ管理外とする。

---

本仕様は計画段階のため、実装時に決定した画面レイアウトやエラーメッセージなど細部が確定次第、適宜更新する。現行挙動との差分は `specs/clear_csv/v1/contract.md` と併読すること。
