# RFC: クリア取込用売上げデータ - 得意先マスタ更新

- Status: Planned
- Owners: （未定）
- Stakeholders: 運用チーム、開発チーム
- Created: 2024-09-03

## 概要
クリア取込用売上げデータ機能で使用している得意先マスタを見直し、以下を実施します。

1. Ippin（ID: `000106`）をリストから除外する。
2. TikTok ショップ（ID: `000109`）を追加し、画面・CSV に反映する。
3. ユーザーが得意先マスタを編集できる UI を整備する。
   - クリア取込用売上げデータ画面に「得意先編集」ボタンを設置。
   - 遷移先でタブ区切り編集画面を提供し、保存で `Config::$customer_path`（タブ区切りファイル）へ書き出す。
   - マスタ読込はファイル優先、存在しない場合はデフォルト（Customers.php）を利用する。

## 背景
- 運用方針の変更により、Ippin 向けのクリア取込データが不要になった。
- TikTok ショップでの販売が始まり、同機能から出力するデータに含めたいという要望が寄せられた。
- 現状の `Customers::$datas` には TikTok ショップのレコードが存在せず、手動対応が発生している。

## ゴール
- 画面に表示される得意先リストから Ippin を削除する。
- TikTok ショップ（ID: `000109`、ショップ名・税区分などの属性は運用要件に従う）を新規追加し、初期表示時に選択状態で含める。
- CSV 出力結果にも上記変更が反映されることを確認する。

## 非ゴール
- CSV レイアウトや項目構成の変更。
- Next Engine API 側の店舗マスタ更新。
- Ippin 以外の得意先情報の見直し。

## 影響範囲
- `tool/include/Customers.php` に定義された顧客配列。
- `tool/download/csv_for_clear.php` での得意先選択初期化ロジック（配列の全件選択）。
- テスト環境（`tool_test/include/Customers.php` 等）も本番と同様に更新する必要がある。

## 実装方針（案）
1. `Customers::$datas` を初期値として扱いつつ、実マスタは `Config::$customer_path`（タブ区切り）に保存する方式へ移行する。
2. 現行マスタから Ippin のレコードを除外し、TikTok ショップのレコードを追加したテンプレートを作成する。
3. クリア取込用売上げデータ画面に「得意先編集」ボタンを追加し、専用画面（`tool_test/` → `tool/`）を実装する。
   - 現在のマスタ内容をテキストエリア等にタブ区切りで表示・編集。
   - 保存時に入力値をバリデーションして `Config::$customer_path` に書き出す。
4. マスタ読み込みロジックを共通化し、ファイルが存在しない場合は `Customers::$datas` を使用するように修正。
5. まず `tool_test/` 側で UI・読込/書込ロジックを実装し、ユーザー検証後に `tool/` へ反映する。
6. 仕様ドキュメント `specs/clear_csv/README.md` および Contract に新フロー（ファイル保存・編集UI・差分反映手順）を追記する。
7. 画面表示と CSV 出力の確認（ローカル動作確認／テスト）の実施。

## マイグレーション / 移行
- 新たに `Config::$customer_path` 用のディレクトリ権限を確認し、書き込み可能とする。
- 既存環境では初回アクセス時に `Customers::$datas` を書き出す初期化処理を検討する。
- リリース後、旧 CSV を使用したバッチがないか運用側で念のため確認する。

## リスクと懸念
- TikTok ショップの属性情報が不足している場合、正しい税区分や JAN、出力名称が決まらない。
- テスト環境との整合性を取り忘れると、検証結果と本番挙動が一致しない可能性がある。
- Ippin 向けデータが完全に不要かどうか要確認（過去データ参照など）。

## オープンな課題
- TikTok ショップの属性を確定する。
  - [確定済] id（得意先コード）・shop_id（店舗番号）: RFC で管理。
  - [確定済] 店舗名称/略称/カナ: 提供済みマスタ情報に従う。
  - [要確認] tax_type（課税/非課税）: 店舗マスタの「税区分」（例：税込/税抜）との対応関係を決める。
  - [要確認] tax_method（内税/免税 など）: 店舗マスタの「税計算順序」（例：単価から税計算/商品計で税計算）からのマッピングを決定する。
  - [要確認] jan / goods_name: 特殊コードとして扱う必要があるか判断する（必要がなければ null）。
- 運用開始時期とリリーススケジュールの調整。
- 新 UI（得意先編集画面）の仕様・レイアウト・権限チェック。
- 追加で必要なテストケース（例：TikTok ショップのみ選択した場合の CSV 内容、マスタ編集後の反映確認）の定義。
