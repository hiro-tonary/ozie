# RFC: クリア取込用売上げデータ - 得意先マスタ更新

- Status: In Progress
- Owners: （未定）
- Stakeholders: 運用チーム、開発チーム
- Created: 2024-09-03

## 概要
クリア取込用売上げデータ機能で使用している得意先マスタを外部ファイル化し、運用側で自由にメンテナンスできるようにします。

1. マスタを `Config::$customer_path`（タブ区切りファイル）へ切り替え、`Customers::$datas` は初期テンプレートとして扱う。
2. クリア取込用売上げデータ画面に「得意先編集」ボタンを設置し、タブ区切り編集 UI を提供する。
3. ファイルが存在しない場合はテンプレートを基に自動生成し、画面・CSV は常にファイル内容を参照する。

## 背景
- 運用方針の変更により、Ippin 向けのクリア取込データが不要になった。
- TikTok ショップでの販売が始まり、同機能から出力するデータに含めたいという要望が寄せられた。
- 現状の `Customers::$datas` には TikTok ショップのレコードが存在せず、手動対応が発生している。

## ゴール
- 得意先マスタを `Config::$customer_path` で管理し、画面・CSV が常に同ファイルの内容を反映する。
- クリア取込用売上げデータ画面から「得意先編集」を開き、ユーザー自身が店舗の追加・削除・属性編集を行える。
- サンプルマスタ（`config.example/ozie_customers*.tsv`）を整備し、初期導入時に利用できる状態にする。

## 非ゴール
- CSV レイアウトや項目構成の変更。
- Next Engine API 側の店舗マスタ更新。
- Ippin 以外の得意先情報の見直し。

## 影響範囲
- `tool/include/Customers.php` に定義された顧客配列。
- `tool/download/csv_for_clear.php` での得意先選択初期化ロジック（配列の全件選択）。
- テスト環境（`tool_test/include/Customers.php` 等）も本番と同様に更新する必要がある。

## 実装方針（案）
1. `Customers::$datas` を初期値として扱いつつ、実マスタは `Config::$customer_path`（タブ区切り）に保存する方式へ移行する。
2. `config.example/` 配下にサンプル TSV（本番/テスト用）を用意し、必要に応じて運用側が編集できるよう説明を追加する。
3. クリア取込用売上げデータ画面に「得意先編集」ボタンを追加し、専用画面（`tool_test/` → `tool/`）を実装する。
   - 現在のマスタ内容をテキストエリア等にタブ区切りで表示・編集。
   - 保存時に入力値をバリデーションして `Config::$customer_path` に書き出す。
4. マスタ読み込みロジックを共通化し、ファイルが存在しない場合は `Customers::$datas` を使用するように修正。
5. まず `tool_test/` 側で UI・読込/書込ロジックを実装し、ユーザー検証後に `tool/` へ反映する。
6. 仕様ドキュメント `specs/clear_csv/README.md` および Contract に新フロー（ファイル保存・編集UI・差分反映手順）を追記する。
7. 画面表示と CSV 出力の確認（ローカル動作確認／テスト）の実施。

## マイグレーション / 移行
- 新たに `Config::$customer_path` 用のディレクトリ権限を確認し、書き込み可能とする。
- 既存環境では初回アクセス時に `Customers::$datas` を書き出す初期化処理を検討する。
- リリース後、旧 CSV を使用したバッチがないか運用側で念のため確認する。

## リスクと懸念
- 運用側が入力する得意先データのバリデーションが不十分だと、CSV 出力に意図しない値が混在する恐れがある。
- テスト環境との整合性を取り忘れると、検証結果と本番挙動が一致しない可能性がある。
- 旧マスタ（コード内配列）とファイルの乖離が発生しないよう、テンプレート更新手順を明確にする必要がある。

## オープンな課題
- サンプル TSV に含める店舗情報（例: TikTok ショップ）の初期値を整理し、運用側に編集手順を周知する。
- 運用開始時期とリリーススケジュールの調整。
- 新 UI（得意先編集画面）の仕様・レイアウト・権限チェック。
- 追加で必要なテストケース（例：TikTok ショップのみ選択した場合の CSV 内容、マスタ編集後の反映確認）の定義。
